# ‚úÖ SQL Migrations - Best Practices Applied

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ SERIAL ‚Üí IDENTITY
```sql
-- ‚ùå –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (—É—Å—Ç–∞—Ä–µ–ª)
id SERIAL PRIMARY KEY

-- ‚úÖ –ù–æ–≤—ã–π —Å–ø–æ—Å–æ–± (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
```

### 2. ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
```sql
-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ PostgreSQL)
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255),
    INDEX idx_email (email)  -- ‚ùå –æ—à–∏–±–∫–∞!
);

-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(255)
);
CREATE INDEX idx_email ON users(email);
```

### 3. ‚úÖ GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è JSONB
```sql
-- –î–ª—è JSONB –ø–æ–ª–µ–π –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π GIN
CREATE INDEX idx_ai_memory_data ON ai.memory_facts USING GIN(fact_data);
CREATE INDEX idx_analytics_labels ON analytics.metrics USING GIN(labels);
```

### 4. ‚úÖ FLOAT ‚Üí DOUBLE PRECISION
```sql
-- ‚ùå –°—Ç–∞—Ä—ã–π
quality_score FLOAT

-- ‚úÖ –ù–æ–≤—ã–π
quality_score DOUBLE PRECISION
```

### 5. ‚úÖ NOT NULL –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
```sql
-- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π NOT NULL –≥–¥–µ –Ω—É–∂–Ω–æ
created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
```

### 6. ‚úÖ UUID auto-generation
```sql
-- –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö
session_id UUID NOT NULL DEFAULT gen_random_uuid()
```

### 7. ‚úÖ TTL Cleanup —Ñ—É–Ω–∫—Ü–∏—è
```sql
-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è expired cache
CREATE OR REPLACE FUNCTION ai.cleanup_expired_cache()
RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM ai.cache_entries WHERE expires_at < NOW();
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

-- –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å (–∏–∑ Rust –∏–ª–∏ pg_cron)
SELECT ai.cleanup_expired_cache();
```

### 8. ‚úÖ Auto-update trigger –¥–ª—è updated_at
```sql
CREATE OR REPLACE FUNCTION ai.update_modified_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_memory_facts_timestamp
    BEFORE UPDATE ON ai.memory_facts
    FOR EACH ROW
    EXECUTE FUNCTION ai.update_modified_timestamp();
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ú–∏–≥—Ä–∞—Ü–∏–π

```
migrations/
‚îú‚îÄ‚îÄ 001_create_schemas.sql        # –°—Ö–µ–º—ã + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
‚îú‚îÄ‚îÄ 002_create_ai_tables.sql      # AI —Ç–∞–±–ª–∏—Ü—ã + –∏–Ω–¥–µ–∫—Å—ã
‚îú‚îÄ‚îÄ 003_create_blockchain_tables.sql  # Blockchain + FK
‚îú‚îÄ‚îÄ 004_create_analytics_tables.sql   # Analytics + materialized view
‚îú‚îÄ‚îÄ 005_create_functions.sql      # Cleanup + triggers
‚îî‚îÄ‚îÄ 006_permissions.sql           # RBAC (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

---

## üöÄ –ó–∞–ø—É—Å–∫ –ú–∏–≥—Ä–∞—Ü–∏–π

### –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç):
```bash
chmod +x migrate.sh
./migrate.sh
```

### –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ psql):
```bash
export DATABASE_URL="postgresql://neondb_owner:npg_dz4Gl8ZhPLbX@ep-soft-mud-agon8wu3-pooler.c-2.eu-central-1.aws.neon.tech/neondb?sslmode=require"

psql "$DATABASE_URL" -f migrations/001_create_schemas.sql
psql "$DATABASE_URL" -f migrations/002_create_ai_tables.sql
psql "$DATABASE_URL" -f migrations/003_create_blockchain_tables.sql
psql "$DATABASE_URL" -f migrations/004_create_analytics_tables.sql
psql "$DATABASE_URL" -f migrations/005_create_functions.sql
psql "$DATABASE_URL" -f migrations/006_permissions.sql
```

### –° –ø–æ–º–æ—â—å—é sqlx (Rust):
```bash
# Install sqlx-cli
cargo install sqlx-cli --no-default-features --features postgres

# Run migrations
sqlx migrate run
```

---

## üîí –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ü—Ä–∞–≤ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏:
```sql
-- Go backend role
CREATE ROLE app_go LOGIN PASSWORD 'secure_password_1';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_go;

-- Rust backend role
CREATE ROLE app_rust LOGIN PASSWORD 'secure_password_2';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO app_rust;  -- read-only
GRANT ALL ON ALL TABLES IN SCHEMA ai, blockchain, analytics TO app_rust;  -- full access
```

### Connection strings:
```bash
# Go backend
GO_DATABASE_URL="postgresql://app_go:password@host/db?sslmode=require"

# Rust backend (with search_path)
DATABASE_URL="postgresql://app_rust:password@host/db?sslmode=require&options=-c%20search_path=ai,blockchain,analytics,public"
```

---

## üìä –ù–æ–≤—ã–µ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. Auto-cleanup expired cache
```rust
// –í Rust –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
let deleted = sqlx::query_scalar!("SELECT ai.cleanup_expired_cache()")
    .fetch_one(&pool)
    .await?;
println!("Deleted {} expired cache entries", deleted);
```

### 2. Refresh analytics
```rust
sqlx::query!("SELECT analytics.refresh_daily_stats()")
    .execute(&pool)
    .await?;
```

### 3. Cross-schema queries
```rust
let user_with_balance = sqlx::query!(
    r#"
    SELECT 
        u.id, u.email, u.name,
        COALESCE(w.balance, 0) as "balance!"
    FROM public.users u
    LEFT JOIN blockchain.wallets w ON u.id = w.user_id
    WHERE u.email = $1
    "#,
    email
)
.fetch_one(&pool)
.await?;
```

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π –ß–µ–∫–ª–∏—Å—Ç

- [x] SERIAL ‚Üí IDENTITY
- [x] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- [x] GIN –¥–ª—è JSONB
- [x] DOUBLE PRECISION –≤–º–µ—Å—Ç–æ FLOAT
- [x] NOT NULL –¥–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- [x] UUID —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
- [x] Foreign keys –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] TTL cleanup —Ñ—É–Ω–∫—Ü–∏—è
- [x] Auto-update trigger –¥–ª—è updated_at
- [x] Materialized view –¥–ª—è analytics
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ —Ä–∞–∑–ª–æ–∂–µ–Ω—ã –ø–æ —Ñ–∞–π–ª–∞–º
- [x] –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ migrations
- [x] Permissions (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–π –®–∞–≥

**–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
./migrate.sh
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
üóÑÔ∏è  FodiFood Database Migration
================================
‚úÖ Loaded DATABASE_URL from .env
üì° Target database: postgresql://neondb_owner...

üìã Found 6 migration files

üîÑ Applying: 001_create_schemas.sql
‚úÖ Success: 001_create_schemas.sql

üîÑ Applying: 002_create_ai_tables.sql
‚úÖ Success: 002_create_ai_tables.sql

... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏)

üéâ All migrations applied successfully!
```

**–ë–∞–∑–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ! üöÄ**
